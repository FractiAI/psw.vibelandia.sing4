<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Text-to-Track Motor — Seed:Edge · Production WAV | VIBELANDIA!</title>
    <meta name="description" content="Text-to-track motor. Songs in text → studio-quality production WAV. Seed + Edge + executive instruction. Copyright-free. Download · Playlist · Catalog NSPFRNP.">
    <link rel="stylesheet" href="experience-common.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(180deg, #0a0a12 0%, #12122a 50%, #0a0a12 100%);
            color: #e8e6e3;
            min-height: 100vh;
            line-height: 1.6;
        }
        .container { max-width: 720px; margin: 0 auto; padding: 2rem 1.5rem; }
        .back { margin-bottom: 1.5rem; }
        .back a { color: #00d4ff; text-decoration: none; }
        .back a:hover { text-decoration: underline; }
        .hero {
            text-align: center;
            padding: 2rem 1.5rem 2.5rem;
            margin-bottom: 2rem;
            background: linear-gradient(145deg, rgba(13, 148, 136, 0.15) 0%, rgba(184, 134, 11, 0.08) 50%, rgba(13, 148, 136, 0.08) 100%);
            border: 2px solid rgba(13, 148, 136, 0.4);
            border-radius: 16px;
        }
        .hero .badge {
            display: inline-block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: rgba(13, 148, 136, 0.95);
            margin-bottom: 0.75rem;
            font-weight: 700;
        }
        .hero h1 {
            font-size: clamp(1.4rem, 4vw, 2rem);
            font-weight: 700;
            background: linear-gradient(135deg, #0d9488, #b8860b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        .hero .tagline { font-size: 0.95rem; color: #b0b8c0; }
        .form-group { margin-bottom: 1.25rem; }
        .form-group label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: #0d9488;
            margin-bottom: 0.4rem;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(13, 148, 136, 0.3);
            border-radius: 10px;
            color: #e8e6e3;
            font-family: inherit;
            font-size: 1rem;
        }
        .form-group textarea { min-height: 140px; resize: vertical; }
        .form-group input::placeholder, .form-group textarea::placeholder { color: #6b7280; }
        .form-row { display: flex; gap: 1rem; flex-wrap: wrap; }
        .form-row .form-group { flex: 1; min-width: 140px; }
        .btn-generate {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.75rem;
            background: linear-gradient(135deg, #0d9488, #0f766e);
            color: #fff;
            font-weight: 700;
            font-size: 1rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-generate:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(13, 148, 136, 0.4); }
        .btn-generate:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .output-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(184, 134, 11, 0.3);
            border-radius: 14px;
            display: none;
        }
        .output-section.visible { display: block; }
        .output-section h3 {
            font-size: 1rem;
            color: #d4af37;
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        .btn-download {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #d4af37, #b8860b);
            color: #0c0c0c;
            font-weight: 700;
            text-decoration: none;
            border-radius: 10px;
            font-size: 0.95rem;
            margin-right: 0.75rem;
            margin-bottom: 0.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn-download:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4); }
        .btn-add-playlist, .btn-add-catalog {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 1rem;
            background: rgba(13, 148, 136, 0.2);
            border: 1px solid rgba(13, 148, 136, 0.5);
            color: #0d9488;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            transition: background 0.2s;
        }
        .btn-add-playlist:hover, .btn-add-catalog:hover { background: rgba(13, 148, 136, 0.35); }
        .playlist-section, .catalog-section {
            margin-top: 2rem;
            padding: 1.25rem;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 12px;
        }
        .playlist-section h3, .catalog-section h3 {
            font-size: 0.9rem;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
        }
        .playlist-list, .catalog-list {
            list-style: none;
        }
        .playlist-list li, .catalog-list li {
            padding: 0.6rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .playlist-list li:last-child, .catalog-list li:last-child { border-bottom: none; }
        .playlist-list a, .catalog-list a { color: #0d9488; text-decoration: none; font-weight: 500; }
        .playlist-list a:hover, .catalog-list a:hover { text-decoration: underline; }
        .status-msg { margin-top: 1rem; font-size: 0.9rem; color: #9ca3af; }
        .status-msg.success { color: #0d9488; }
        .status-msg.error { color: #f87171; }
        .genre-custom-panel {
            margin-top: 1rem;
            padding: 1.25rem;
            background: rgba(13, 148, 136, 0.08);
            border: 1px solid rgba(13, 148, 136, 0.35);
            border-radius: 12px;
            display: none;
        }
        .genre-custom-panel.visible { display: block; }
        .genre-custom-panel label { font-size: 0.8rem; color: #0d9488; font-weight: 600; display: block; margin-bottom: 0.4rem; }
        .genre-custom-panel .describe-sound { width: 100%; padding: 0.6rem 0.9rem; background: rgba(255,255,255,0.06); border: 1px solid rgba(13,148,136,0.3); border-radius: 8px; color: #e8e6e3; font-size: 0.95rem; margin-bottom: 0.75rem; }
        .btn-suggest { padding: 0.5rem 1rem; background: rgba(212, 175, 55, 0.2); border: 1px solid rgba(212, 175, 55, 0.5); color: #d4af37; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; margin-bottom: 1rem; }
        .btn-suggest:hover { background: rgba(212, 175, 55, 0.35); }
        .custom-lineup-list { list-style: none; margin: 0.75rem 0 0; padding: 0; }
        .custom-lineup-list li {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.5rem 0.75rem; margin-bottom: 0.4rem;
            background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.08);
        }
        .custom-lineup-list li .ord { font-size: 0.75rem; color: #6b7280; min-width: 1.5rem; }
        .custom-lineup-list li .name-instr { flex: 1; font-size: 0.9rem; color: #e8e6e3; }
        .custom-lineup-list li .btn-remove { padding: 0.2rem 0.5rem; background: rgba(248,113,113,0.2); border: 1px solid rgba(248,113,113,0.4); color: #f87171; border-radius: 6px; cursor: pointer; font-size: 0.75rem; }
        .custom-lineup-list li .btn-remove:hover { background: rgba(248,113,113,0.35); }
        .custom-lineup-add { margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center; }
        .custom-lineup-add select { padding: 0.5rem 0.75rem; background: rgba(255,255,255,0.06); border: 1px solid rgba(13,148,136,0.3); border-radius: 8px; color: #e8e6e3; font-size: 0.9rem; min-width: 160px; }
        .custom-lineup-add .btn-add-musician { padding: 0.5rem 1rem; background: rgba(13, 148, 136, 0.25); border: 1px solid rgba(13, 148, 136, 0.5); color: #0d9488; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .custom-lineup-add .btn-add-musician:hover { background: rgba(13, 148, 136, 0.4); }
        .hero-ai-hint { font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem; }
        .dream-teams-section {
            margin-top: 1.5rem; padding: 1.25rem;
            background: linear-gradient(145deg, rgba(212, 175, 55, 0.08) 0%, rgba(13, 148, 136, 0.06) 100%);
            border: 1px solid rgba(212, 175, 55, 0.35);
            border-radius: 12px;
        }
        .dream-teams-section h3 { font-size: 0.9rem; color: #d4af37; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem; }
        .dream-teams-section .ep-badge { font-size: 0.75rem; color: #b8860b; margin-bottom: 0.75rem; }
        .dream-teams-section .load-row { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-bottom: 1rem; }
        .dream-teams-section .load-row select { flex: 1; min-width: 180px; padding: 0.5rem 0.75rem; background: rgba(255,255,255,0.06); border: 1px solid rgba(212, 175, 55, 0.35); border-radius: 8px; color: #e8e6e3; font-size: 0.95rem; }
        .dream-teams-section .save-row { display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap; margin-bottom: 1rem; }
        .dream-teams-section .save-row input { flex: 1; min-width: 160px; padding: 0.5rem 0.75rem; background: rgba(255,255,255,0.06); border: 1px solid rgba(212, 175, 55, 0.35); border-radius: 8px; color: #e8e6e3; font-size: 0.95rem; }
        .dream-teams-section .btn-save-dream { padding: 0.5rem 1rem; background: rgba(212, 175, 55, 0.25); border: 1px solid rgba(212, 175, 55, 0.5); color: #d4af37; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .dream-teams-section .btn-save-dream:hover { background: rgba(212, 175, 55, 0.4); }
        .dream-teams-list { list-style: none; margin: 0; padding: 0; }
        .dream-teams-list li { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid rgba(255,255,255,0.06); flex-wrap: wrap; }
        .dream-teams-list li:last-child { border-bottom: none; }
        .dream-teams-list .team-name { flex: 1; min-width: 120px; font-size: 0.95rem; color: #e8e6e3; }
        .dream-teams-list .btn-load-dream { padding: 0.35rem 0.75rem; background: rgba(13, 148, 136, 0.25); border: 1px solid rgba(13, 148, 136, 0.5); color: #0d9488; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; }
        .dream-teams-list .btn-load-dream:hover { background: rgba(13, 148, 136, 0.4); }
        .dream-teams-list .btn-delete-dream { padding: 0.35rem 0.75rem; background: rgba(248, 113, 113, 0.15); border: 1px solid rgba(248, 113, 113, 0.4); color: #f87171; border-radius: 6px; font-size: 0.8rem; cursor: pointer; }
        .dream-teams-list .btn-delete-dream:hover { background: rgba(248, 113, 113, 0.3); }
        footer { margin-top: 2.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; color: #6b7280; font-size: 0.9rem; }
        footer a { color: #00d4ff; }
    </style>
</head>
<body>
    <div class="container">
        <p class="back"><a href="music-studio.html">← Music Studio</a> · <a href="school-of-music.html">School of Music</a> · <a href="office-hours.html">Office Hours</a> · <a href="launch-pad.html">Launch Pad</a> · <a href="../index.html">Home</a></p>

        <div class="hero">
            <span class="badge">1 · 2 · 3 · 4×4×4×4 — Baller producers</span>
            <h1>Text-to-Track Motor</h1>
            <p class="tagline"><strong>1</strong> Lyrics · <strong>2</strong> Genre · <strong>3</strong> Generate. One WAV per song. For baller producers — simple.</p>
            <p style="margin-top: 1rem; font-size: 0.85rem; color: rgba(13, 148, 136, 0.95); padding: 0.6rem 1rem; background: rgba(13, 148, 136, 0.1); border: 1px solid rgba(13, 148, 136, 0.35); border-radius: 10px;"><strong>In progress:</strong> We're currently working on our studio quality engine. Full WAV output via Hero Jo Golden Backdoor Hit Factory — CONNECT! to use when configured. Squeeze to 98% mastery.</p>
        </div>

        <p id="preset-ready-msg" class="status-msg success" style="display: none; margin-bottom: 1rem;">Lyrics loaded. Hit <strong>Generate</strong> below.</p>

        <form id="motor-form" style="max-width: 520px; margin: 0 auto 2rem;">
            <p style="font-size: 1rem; font-weight: 700; color: #d4af37; margin-bottom: 0.5rem;">1 — Lyrics</p>
            <div style="margin-bottom: 0.5rem;">
                <a href="text-to-track-motor.html?song=te-quiero-mucho-baby" id="preset-te-quiero" class="btn-load-dream" style="display:inline-block;padding:0.5rem 0.9rem;text-decoration:none;margin-right:0.5rem;margin-bottom:0.5rem;">Te Quiero Mucho Baby</a>
                <a href="text-to-track-motor.html?song=dorila-gao" id="preset-dorila" class="btn-load-dream" style="display:inline-block;padding:0.5rem 0.9rem;text-decoration:none;margin-bottom:0.5rem;">Dorila Gao</a>
            </div>
            <div class="form-group">
                <label for="songs-text">Paste or type lyrics</label>
                <textarea id="songs-text" name="songs-text" placeholder="Paste or type your lyrics here."></textarea>
            </div>

            <p style="font-size: 1rem; font-weight: 700; color: #d4af37; margin: 1.25rem 0 0.5rem;">2 — Genre</p>
            <div class="form-group">
                <label for="genre">Pick a vibe</label>
                <select id="genre" name="genre" style="width:100%;padding:0.75rem 1rem;background:rgba(255,255,255,0.06);border:1px solid rgba(13,148,136,0.3);border-radius:10px;color:#e8e6e3;font-size:1rem;">
                    <option value="reggaeton">Reggaetón</option>
                    <option value="ballad">Ballad</option>
                    <option value="urban">Urban</option>
                    <option value="rock">Rock</option>
                    <option value="jazz">Jazz</option>
                    <option value="electronic">Electronic</option>
                    <option value="custom">Other (custom)</option>
                </select>
            </div>
            <div id="genre-custom-panel" class="genre-custom-panel" style="margin-top: 0.75rem;">
                <label for="describe-sound">Describe your sound</label>
                <input type="text" id="describe-sound" class="describe-sound" placeholder="e.g. chill ballad, club banger">
                <button type="button" id="btn-suggest-lineup" class="btn-suggest">Suggest lineup</button>
                <p class="hero-ai-hint">Suggest musicians from your description.</p>
                <label style="margin-top: 0.75rem;">Your lineup</label>
                <ul id="custom-lineup-list" class="custom-lineup-list"></ul>
                <div class="custom-lineup-add">
                    <select id="add-musician-select"><option value="">— Add musician —</option></select>
                    <button type="button" id="btn-add-musician" class="btn-add-musician">Add</button>
                </div>
            </div>

            <p style="font-size: 1rem; font-weight: 700; color: #d4af37; margin: 1.25rem 0 0.5rem;">3 — Generate</p>
            <button type="submit" class="btn-generate" id="btn-generate">Generate entire song (one WAV)</button>

            <details id="more-options" style="margin-top: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 10px;">
                <summary style="cursor: pointer; font-size: 0.9rem; color: #9ca3af;">More options (team, BPM, etc.)</summary>
                <div style="margin-top: 1rem;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="seed">Seed</label>
                            <input type="text" id="seed" name="seed" value="C4" placeholder="C4">
                        </div>
                        <div class="form-group">
                            <label for="edge">Edge</label>
                            <input type="text" id="edge" name="edge" value="studio" placeholder="studio">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="team">Team</label>
                        <select id="team" name="team" style="width:100%;padding:0.75rem 1rem;background:rgba(255,255,255,0.06);border:1px solid rgba(13,148,136,0.3);border-radius:10px;color:#e8e6e3;font-size:1rem;">
                            <option value="studio">Studio</option>
                            <option value="concert">Concert</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="executive">Vibe (BPM, tone)</label>
                        <input type="text" id="executive" name="executive" value="smooth finish, studio quality, 92 BPM" placeholder="e.g. 92 BPM, warm">
                    </div>
                    <div style="margin-top: 0.75rem;">
                        <label for="load-dream-team">Load dream team</label>
                        <select id="load-dream-team" style="width:100%;padding:0.5rem;background:rgba(255,255,255,0.06);border:1px solid rgba(13,148,136,0.3);border-radius:8px;color:#e8e6e3;">
                            <option value="">— Use genre above —</option>
                        </select>
                    </div>
                    <div class="save-row" style="margin-top: 0.75rem;">
                        <input type="text" id="dream-team-name" placeholder="Name this dream team" maxlength="80" style="flex:1;padding:0.5rem;background:rgba(255,255,255,0.06);border:1px solid rgba(13,148,136,0.3);border-radius:8px;color:#e8e6e3;">
                        <button type="button" id="btn-save-dream-team" class="btn-save-dream">Save lineup</button>
                    </div>
                    <ul id="dream-teams-list" class="dream-teams-list"></ul>
                    <div class="form-group" style="display: none;" id="num-tracks-wrap">
                        <label for="num-tracks">Layers in mix</label>
                        <select id="num-tracks" name="num-tracks" style="width:100%;padding:0.5rem;background:rgba(255,255,255,0.06);border:1px solid rgba(13,148,136,0.3);border-radius:8px;color:#e8e6e3;">
                            <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6" selected>6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
                        </select>
                    </div>
                </div>
            </details>
        </form>

        <div class="output-section" id="output-section">
            <h3>Entire song ready</h3>
            <p id="output-filename" class="status-msg"></p>
            <div id="download-list"></div>
            <button type="button" class="btn-add-playlist" id="btn-add-playlist">+ Add to playlist</button>
            <button type="button" class="btn-add-catalog" id="btn-add-catalog">+ Add to catalog (NSPFRNP)</button>
            <button type="button" class="btn-add-catalog" id="btn-copy-catalog" style="margin-left: 0;">Copy catalog entry (markdown)</button>
        </div>

        <div class="playlist-section" style="max-width: 520px; margin: 0 auto;">
            <h3 style="font-size: 0.9rem;">Playlist (this session)</h3>
            <ul class="playlist-list" id="playlist-list"></ul>
        </div>

        <div class="catalog-section" style="max-width: 520px; margin: 0 auto;">
            <h3 style="font-size: 0.9rem;">Catalog</h3>
            <ul class="catalog-list" id="catalog-list"></ul>
        </div>

        <footer>
            <p><a href="music-studio.html">Music Studio</a> · <a href="baller-v-producer.html">BALLER V PRODUCER!</a> · <a href="baller-v-plans-booking.html#studio-fees">Fees (4×4×4×4)</a> · <a href="../index.html">Home</a></p>
        </footer>
    </div>

    <script>
(function () {
    var SAMPLE_RATE = 44100;
    var DEFAULT_DURATION_SEC = 12;
    var STUDIO_BPM = 92;

    function noteToHz(name) {
        var notes = { C: 0, D: 2, E: 4, F: 5, G: 7, A: 9, B: 11 };
        var match = (name || 'C4').trim().toUpperCase().match(/^([A-G])([#b])?(\d+)?$/);
        if (!match) return 261.63;
        var semitone = (notes[match[1]] || 0) + (match[2] === '#' ? 1 : match[2] === 'b' ? -1 : 0);
        var octave = parseInt(match[3], 10) || 4;
        return 440 * Math.pow(2, (octave - 4) + semitone / 12);
    }

    function textHash(str) {
        var h = 0;
        for (var i = 0; i < (str || '').length; i++) h = ((h << 5) - h) + str.charCodeAt(i) | 0;
        return h;
    }

    function seedEdgeToFreq(seedStr, edgeStr, text) {
        var base = noteToHz(seedStr);
        var detune = (Math.abs(textHash(text)) % 7) - 3;
        return base * Math.pow(2, detune / 12);
    }

    function rnd(seed) { return (Math.sin(seed * 12.9898) * 43758.5453) % 1; }

    function parseBPM(executive) {
        var match = (executive || '').match(/\b(\d{2,3})\s*BPM\b/i);
        return match ? Math.min(180, Math.max(60, parseInt(match[1], 10))) : STUDIO_BPM;
    }

    function textToDurationSec(text, executive) {
        var words = (text || '').trim().split(/\s+/).filter(Boolean).length;
        if (words === 0) return DEFAULT_DURATION_SEC;
        return Math.min(90, Math.max(8, 8 + Math.floor(words / 3)));
    }

    /** Master studio musicians — best-fit holographic name + their instrument. Track = musician · instrument. */
    var MASTER_STUDIO_MUSICIANS = [
        { name: 'Sera', instrument: 'Bass' },
        { name: 'Kael', instrument: 'Drums' },
        { name: 'Nola', instrument: 'Pad' },
        { name: 'Lyra', instrument: 'Lead' },
        { name: 'Rune', instrument: 'Keys' },
        { name: 'Vex', instrument: 'Strings' },
        { name: 'Bram', instrument: 'Brass' },
        { name: 'Echo', instrument: 'Perc' },
        { name: 'Zephyr', instrument: 'Synth' },
        { name: 'Orin', instrument: 'Vox' },
        { name: 'Flux', instrument: 'FX' },
        { name: 'Maestro', instrument: 'Producer/Conductor' }
    ];

    /** Top 6 genre lineups: each is an ordered array of musician indices (0–11). */
    var GENRE_LINEUPS = {
        reggaeton: [0, 1, 7, 8, 9, 4, 2, 3, 5, 6, 10, 11],
        ballad: [2, 5, 3, 9, 4, 0, 1, 6, 7, 8, 10, 11],
        urban: [0, 1, 4, 8, 9, 3, 2, 5, 6, 7, 10, 11],
        rock: [1, 0, 3, 4, 6, 7, 2, 5, 8, 9, 10, 11],
        jazz: [0, 1, 4, 6, 5, 3, 9, 2, 7, 8, 10, 11],
        electronic: [8, 0, 1, 2, 10, 7, 3, 4, 5, 6, 9, 11]
    };

    function getMusicianByIndex(idx) {
        var m = MASTER_STUDIO_MUSICIANS[idx % MASTER_STUDIO_MUSICIANS.length];
        return { name: m.name, instrument: m.instrument, display: m.name + ' · ' + m.instrument };
    }

    function getMusicianForTrack(index, lineup) {
        if (lineup && Array.isArray(lineup) && lineup.length > 0) {
            var idx = lineup[index % lineup.length];
            return getMusicianByIndex(idx);
        }
        return getMusicianByIndex(index);
    }

    function getCurrentLineup() {
        var genre = (document.getElementById('genre') && document.getElementById('genre').value) || 'reggaeton';
        if (genre === 'custom') {
            var list = document.getElementById('custom-lineup-list');
            if (!list) return GENRE_LINEUPS.reggaeton.slice();
            var indices = [];
            for (var i = 0; i < list.children.length; i++) {
                var dataIdx = list.children[i].getAttribute('data-index');
                if (dataIdx !== null && dataIdx !== '') indices.push(parseInt(dataIdx, 10));
            }
            return indices.length > 0 ? indices : GENRE_LINEUPS.reggaeton.slice();
        }
        return (GENRE_LINEUPS[genre] || GENRE_LINEUPS.reggaeton).slice();
    }

    function buildNumTracksOptions(lineup) {
        var sel = document.getElementById('num-tracks');
        if (!sel) return;
        lineup = lineup || getCurrentLineup();
        var maxN = Math.min(12, lineup.length);
        if (maxN < 1) maxN = 1;
        var current = Math.min(12, Math.max(1, parseInt(sel.value, 10) || 6));
        sel.value = String(Math.min(current, maxN));
    }

    /** One track = one master musician (holographic name) and their instrument. Artist creator gives exec instruction to his studio or concert team. Copyright-free: oscillators only. */
    function renderTrack(options) {
        var text = options.text || '';
        var seed = options.seed || 'C4';
        var edge = options.edge || 'studio';
        var team = options.team || 'studio';
        var executive = options.executive || '';
        var trackIndex = options.trackIndex != null ? options.trackIndex : 0;
        var musician = options.musician != null ? options.musician : getMusicianForTrack(trackIndex);
        var instrumentRole = musician.instrument;
        var durationSec = options.durationSec || textToDurationSec(text, executive);
        var length = Math.ceil(SAMPLE_RATE * durationSec);
        var numChannels = 2;
        var ctx = new OfflineAudioContext(numChannels, length, SAMPLE_RATE);
        var hash = textHash(text + seed + edge + team + String(trackIndex));
        var rootHz = seedEdgeToFreq(seed, edge, text);
        var bpm = parseBPM(executive);
        var beatSec = 60 / bpm;
        var barSec = beatSec * 4;

        var masterGain = ctx.createGain();
        masterGain.gain.setValueAtTime(0, 0);
        masterGain.gain.linearRampToValueAtTime(0.85, 0.3);
        masterGain.gain.setValueAtTime(0.85, durationSec - 0.3);
        masterGain.gain.linearRampToValueAtTime(0, durationSec);
        masterGain.connect(ctx.destination);

        var bassHz = rootHz * 0.5;
        var chordRoot = rootHz;
        var chordThird = rootHz * Math.pow(2, 4 / 12);
        var chordFifth = rootHz * Math.pow(2, 7 / 12);

        if (instrumentRole === 'Bass') {
            for (var t = 0; t < durationSec; t += beatSec) {
                var beatInBar = (t / beatSec) % 4;
                var bassGain = ctx.createGain();
                bassGain.gain.setValueAtTime(0, t);
                bassGain.gain.linearRampToValueAtTime(0.5, t + 0.01);
                bassGain.gain.exponentialRampToValueAtTime(0.01, t + beatSec * 0.4);
                var osc = ctx.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(bassHz * (beatInBar === 0 || beatInBar === 2 ? 1 : Math.pow(2, 5 / 12)), t);
                osc.connect(bassGain);
                bassGain.connect(masterGain);
                osc.start(t);
                osc.stop(t + beatSec * 0.5);
            }
        } else if (instrumentRole === 'Drums') {
            for (var t = 0; t < durationSec; t += beatSec * 0.5) {
                var beatInBar = (t / beatSec) % 4;
                var snareGain = ctx.createGain();
                snareGain.gain.setValueAtTime(0, t);
                snareGain.gain.linearRampToValueAtTime(0.4, t + 0.002);
                snareGain.gain.exponentialRampToValueAtTime(0.001, t + 0.08);
                var noise = ctx.createOscillator();
                noise.type = 'triangle';
                noise.frequency.setValueAtTime(180 + (hash % 200), t);
                var noiseGain = ctx.createGain();
                noiseGain.gain.setValueAtTime(1, t);
                noiseGain.gain.exponentialRampToValueAtTime(0.01, t + 0.08);
                noise.connect(noiseGain);
                noiseGain.connect(snareGain);
                if (beatInBar === 1 || beatInBar === 3) {
                    noise.start(t);
                    noise.stop(t + 0.08);
                    snareGain.connect(masterGain);
                }
            }
        } else if (instrumentRole === 'Pad' || instrumentRole === 'Strings') {
            var padGain = ctx.createGain();
            padGain.gain.setValueAtTime(0, 0);
            padGain.gain.linearRampToValueAtTime(0.35, 1);
            padGain.gain.setValueAtTime(0.35, durationSec - 1);
            padGain.gain.linearRampToValueAtTime(0, durationSec);
            var padOscs = [
                { type: 'sine', freq: chordRoot },
                { type: 'triangle', freq: chordThird },
                { type: 'sine', freq: chordFifth },
                { type: 'sine', freq: chordRoot * 2 }
            ];
            for (var i = 0; i < padOscs.length; i++) {
                var o = ctx.createOscillator();
                o.type = padOscs[i].type;
                o.frequency.setValueAtTime(padOscs[i].freq * (1 + 0.003 * (rnd(hash + i) - 0.5)), 0);
                o.connect(padGain);
                padGain.connect(masterGain);
                o.start(0);
                o.stop(durationSec);
            }
        } else if (instrumentRole === 'Lead' || instrumentRole === 'Synth' || instrumentRole === 'Vox') {
            var leadGain = ctx.createGain();
            leadGain.gain.setValueAtTime(0, 0);
            leadGain.gain.linearRampToValueAtTime(0.45, 1);
            leadGain.gain.setValueAtTime(0.45, durationSec - 1);
            leadGain.gain.linearRampToValueAtTime(0, durationSec);
            var noteIndex = 0;
            for (var t = barSec; t < durationSec - barSec; t += beatSec * 2) {
                var scale = [0, 2, 4, 5, 7, 9, 11];
                var step = scale[Math.abs(hash + noteIndex) % scale.length];
                var leadFreq = chordRoot * 2 * Math.pow(2, step / 12);
                var g = ctx.createGain();
                g.gain.setValueAtTime(0, t);
                g.gain.linearRampToValueAtTime(0.5, t + 0.02);
                g.gain.linearRampToValueAtTime(0.3, t + beatSec * 1.2);
                g.gain.exponentialRampToValueAtTime(0.001, t + beatSec * 2);
                var osc = ctx.createOscillator();
                osc.type = (noteIndex % 3) === 0 ? 'sine' : (noteIndex % 3) === 1 ? 'triangle' : 'sawtooth';
                osc.frequency.setValueAtTime(leadFreq, t);
                osc.connect(g);
                g.connect(leadGain);
                leadGain.connect(masterGain);
                osc.start(t);
                osc.stop(t + beatSec * 2.2);
                noteIndex++;
            }
        } else if (instrumentRole === 'Keys' || instrumentRole === 'Brass') {
            var keysGain = ctx.createGain();
            keysGain.gain.setValueAtTime(0, 0);
            keysGain.gain.linearRampToValueAtTime(0.3, 0.5);
            keysGain.gain.setValueAtTime(0.3, durationSec - 0.5);
            keysGain.gain.linearRampToValueAtTime(0, durationSec);
            for (var t = 0; t < durationSec; t += beatSec * 2) {
                var step = (Math.abs(hash) + Math.floor(t / beatSec)) % 7;
                var scale = [0, 2, 4, 5, 7, 9, 11];
                var f = chordRoot * Math.pow(2, scale[step] / 12);
                var o = ctx.createOscillator();
                o.type = instrumentRole === 'Brass' ? 'sawtooth' : 'triangle';
                o.frequency.setValueAtTime(f, t);
                var g = ctx.createGain();
                g.gain.setValueAtTime(0, t);
                g.gain.linearRampToValueAtTime(0.35, t + 0.02);
                g.gain.exponentialRampToValueAtTime(0.001, t + beatSec * 1.5);
                o.connect(g);
                g.connect(keysGain);
                keysGain.connect(masterGain);
                o.start(t);
                o.stop(t + beatSec * 1.6);
            }
        } else if (instrumentRole === 'Perc' || instrumentRole === 'FX') {
            var hitGain = ctx.createGain();
            hitGain.gain.setValueAtTime(0.4, 0);
            for (var t = beatSec * 0.5; t < durationSec; t += beatSec * (instrumentRole === 'Perc' ? 1 : 2)) {
                var o = ctx.createOscillator();
                o.type = (Math.abs(hash) + Math.floor(t * 4)) % 2 === 0 ? 'sine' : 'triangle';
                o.frequency.setValueAtTime(chordRoot * (2 + rnd(hash + t) * 2), t);
                var g = ctx.createGain();
                g.gain.setValueAtTime(0, t);
                g.gain.linearRampToValueAtTime(0.3, t + 0.01);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
                o.connect(g);
                g.connect(hitGain);
                hitGain.connect(masterGain);
                o.start(t);
                o.stop(t + 0.2);
            }
        } else if (instrumentRole === 'Producer/Conductor') {
            var condGain = ctx.createGain();
            condGain.gain.setValueAtTime(0, 0);
            condGain.gain.linearRampToValueAtTime(0.25, 0.2);
            condGain.gain.setValueAtTime(0.25, durationSec - 0.2);
            condGain.gain.linearRampToValueAtTime(0, durationSec);
            for (var bar = 0; bar < Math.ceil(durationSec / barSec); bar++) {
                var t = bar * barSec;
                var o = ctx.createOscillator();
                o.type = 'sine';
                o.frequency.setValueAtTime(rootHz * 2, t);
                var g = ctx.createGain();
                g.gain.setValueAtTime(0, t);
                g.gain.linearRampToValueAtTime(0.35, t + 0.005);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.08);
                o.connect(g);
                g.connect(condGain);
                condGain.connect(masterGain);
                o.start(t);
                o.stop(t + 0.1);
            }
            for (var t = beatSec; t < durationSec; t += beatSec) {
                var o = ctx.createOscillator();
                o.type = 'triangle';
                o.frequency.setValueAtTime(880 + (hash % 200), t);
                var g = ctx.createGain();
                g.gain.setValueAtTime(0, t);
                g.gain.linearRampToValueAtTime(0.08, t + 0.002);
                g.gain.exponentialRampToValueAtTime(0.001, t + 0.04);
                o.connect(g);
                g.connect(condGain);
                o.start(t);
                o.stop(t + 0.05);
            }
        } else {
            var fallbackGain = ctx.createGain();
            fallbackGain.gain.setValueAtTime(0, 0);
            fallbackGain.gain.linearRampToValueAtTime(0.25, 1);
            fallbackGain.gain.setValueAtTime(0.25, durationSec - 1);
            fallbackGain.gain.linearRampToValueAtTime(0, durationSec);
            var o = ctx.createOscillator();
            o.type = 'sine';
            o.frequency.setValueAtTime(chordRoot, 0);
            o.connect(fallbackGain);
            fallbackGain.connect(masterGain);
            o.start(0);
            o.stop(durationSec);
        }

        return ctx.startRendering();
    }

    function floatTo16BitPCM(float32Array) {
        var buffer = new ArrayBuffer(float32Array.length * 2);
        var view = new DataView(buffer);
        var offset = 0;
        for (var i = 0; i < float32Array.length; i++, offset += 2) {
            var s = Math.max(-1, Math.min(1, float32Array[i]));
            view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
        }
        return buffer;
    }

    function audioBufferToWav(buffer) {
        var numChannels = buffer.numberOfChannels;
        var sampleRate = buffer.sampleRate;
        var duration = buffer.length / sampleRate;
        var length = buffer.length * numChannels * 2;
        var byteRate = sampleRate * numChannels * 2;
        var blockAlign = numChannels * 2;
        var dataSize = buffer.length * numChannels * 2;

        var interleaved = new Float32Array(buffer.length * numChannels);
        for (var i = 0; i < buffer.length; i++) {
            for (var ch = 0; ch < numChannels; ch++) {
                interleaved[i * numChannels + ch] = buffer.getChannelData(ch)[i];
            }
        }
        var pcm = floatTo16BitPCM(interleaved);

        var header = new ArrayBuffer(44);
        var view = new DataView(header);
        function writeStr(offset, str) {
            for (var i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i));
        }
        writeStr(0, 'RIFF');
        view.setUint32(4, 36 + dataSize, true);
        writeStr(8, 'WAVE');
        writeStr(12, 'fmt ');
        view.setUint32(16, 16, true);
        view.setUint16(20, 1, true);
        view.setUint16(22, numChannels, true);
        view.setUint32(24, sampleRate, true);
        view.setUint32(28, byteRate, true);
        view.setUint16(32, blockAlign, true);
        view.setUint16(34, 16, true);
        writeStr(36, 'data');
        view.setUint32(40, dataSize, true);

        var blob = new Blob([header, pcm], { type: 'audio/wav' });
        return blob;
    }

    /** Mix N track buffers into one stereo buffer (entire song). Gain 1/N to avoid clip. */
    function mixAudioBuffers(buffers) {
        if (!buffers || buffers.length === 0) return null;
        if (buffers.length === 1) return buffers[0];
        var numChannels = 2;
        var sampleRate = buffers[0].sampleRate;
        var length = buffers[0].length;
        var n = buffers.length;
        var ctx = new OfflineAudioContext(numChannels, length, sampleRate);
        var gainPerTrack = 1 / Math.sqrt(n);
        for (var i = 0; i < buffers.length; i++) {
            var buf = buffers[i];
            var gain = ctx.createGain();
            gain.gain.value = gainPerTrack;
            var src = ctx.createBufferSource();
            src.buffer = buf;
            src.connect(gain);
            gain.connect(ctx.destination);
            src.start(0);
        }
        return ctx.startRendering();
    }

    var lastOutputs = [];
    var playlist = JSON.parse(localStorage.getItem('textToTrackPlaylist') || '[]');
    var catalog = JSON.parse(localStorage.getItem('textToTrackCatalog') || '[]');
    var DREAM_TEAMS_KEY = 'textToTrackDreamTeams';
    var dreamTeams = JSON.parse(localStorage.getItem(DREAM_TEAMS_KEY) || '[]');

    var DEFAULT_PLAYLIST_WAV = [
        { title: 'Te Quiero Mucho Baby', url: 'audio/te-quiero-mucho-baby.wav', filename: 'te-quiero-mucho-baby.wav', seed: 'C4', edge: 'studio', team: 'studio' },
        { title: 'Dorila Gao', url: 'audio/dorila-gao.wav', filename: 'dorila-gao.wav', seed: 'C4', edge: 'studio', team: 'studio' }
    ];
    var DEFAULT_CATALOG_WAV = [
        { trackId: 'TE-QUIERO-MUCHO-BABY-001', title: 'Te Quiero Mucho Baby', seed: 'C4', edge: 'studio', team: 'studio', filename: 'te-quiero-mucho-baby.wav', musicianDisplay: 'Entire song · WAV', protocol: 'TEXT-TO-TRACK-MOTOR-SEED-EDGE-NSPFRNP' },
        { trackId: 'DORILA-GAO-CLUB-ANTHEM-001', title: 'Dorila Gao', seed: 'C4', edge: 'studio', team: 'studio', filename: 'dorila-gao.wav', musicianDisplay: 'Entire song · WAV', protocol: 'TEXT-TO-TRACK-MOTOR-SEED-EDGE-NSPFRNP' }
    ];

    function savePlaylist() { localStorage.setItem('textToTrackPlaylist', JSON.stringify(playlist)); }
    function saveCatalog() { localStorage.setItem('textToTrackCatalog', JSON.stringify(catalog)); }
    if (playlist.length === 0) {
        playlist = DEFAULT_PLAYLIST_WAV.slice();
        savePlaylist();
    }
    if (catalog.length === 0) {
        catalog = DEFAULT_CATALOG_WAV.slice();
        saveCatalog();
    }
    function saveDreamTeams() { localStorage.setItem(DREAM_TEAMS_KEY, JSON.stringify(dreamTeams)); }

    function applyDreamTeam(lineup) {
        var genreSel = document.getElementById('genre');
        if (genreSel) genreSel.value = 'custom';
        var customPanel = document.getElementById('genre-custom-panel');
        if (customPanel) customPanel.classList.add('visible');
        renderCustomLineupList(lineup);
        var loadSel = document.getElementById('load-dream-team');
        if (loadSel) loadSel.value = '';
    }

    function renderDreamTeamsList() {
        var loadSel = document.getElementById('load-dream-team');
        var listEl = document.getElementById('dream-teams-list');
        if (!loadSel && !listEl) return;
        if (loadSel) {
            loadSel.innerHTML = '<option value="">— Use genre/lineup above —</option>';
            dreamTeams.forEach(function (t) {
                var opt = document.createElement('option');
                opt.value = t.id;
                opt.textContent = t.name;
                loadSel.appendChild(opt);
            });
        }
        if (listEl) {
            listEl.innerHTML = '';
            dreamTeams.forEach(function (t) {
                var li = document.createElement('li');
                li.innerHTML = '<span class="team-name">' + (t.name || 'Unnamed') + '</span><button type="button" class="btn-load-dream" data-id="' + t.id + '">Load</button><button type="button" class="btn-delete-dream" data-id="' + t.id + '" aria-label="Delete">Delete</button>';
                li.querySelector('.btn-load-dream').addEventListener('click', function () {
                    applyDreamTeam(t.lineup || []);
                });
                li.querySelector('.btn-delete-dream').addEventListener('click', function () {
                    dreamTeams = dreamTeams.filter(function (x) { return x.id !== t.id; });
                    saveDreamTeams();
                    renderDreamTeamsList();
                });
                listEl.appendChild(li);
            });
        }
    }

    function slug(str) {
        return (str || 'track').replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '').slice(0, 48) || 'track';
    }

    function renderPlaylist() {
        var ul = document.getElementById('playlist-list');
        ul.innerHTML = '';
        playlist.forEach(function (item, i) {
            var li = document.createElement('li');
            var a = document.createElement('a');
            a.href = item.url;
            a.download = item.filename;
            a.textContent = item.title || item.filename;
            li.appendChild(a);
            var disp = item.musicianDisplay || (item.musicianName && item.musicianInstrument ? item.musicianName + ' · ' + item.musicianInstrument : null) || (item.instrumentRole ? item.instrumentRole : null);
            li.appendChild(document.createTextNode((disp ? ' · ' + disp : '') + ' · ' + (item.seed || '') + ' → ' + (item.edge || '')));
            ul.appendChild(li);
        });
    }

    function renderCatalog() {
        var ul = document.getElementById('catalog-list');
        ul.innerHTML = '';
        catalog.forEach(function (item) {
            var li = document.createElement('li');
            var disp = item.musicianDisplay || (item.musicianName && item.musicianInstrument ? item.musicianName + ' · ' + item.musicianInstrument : null) || (item.instrumentRole ? item.instrumentRole : null);
            li.textContent = (item.title || item.trackId) + (disp ? ' — ' + disp : '') + ' — Seed: ' + (item.seed || '') + ', Edge: ' + (item.edge || '') + (item.filename ? ' · ' + item.filename : '');
            ul.appendChild(li);
        });
    }

    function suggestLineupFromDescribe(text) {
        var t = (text || '').toLowerCase();
        if (/\b(ballad|chill|soft|slow|emotional)\b/.test(t)) return GENRE_LINEUPS.ballad.slice();
        if (/\b(reggaeton|perreo|club|dembow|latino)\b/.test(t)) return GENRE_LINEUPS.reggaeton.slice();
        if (/\b(urban|hip-hop|hiphop|trap|r&b)\b/.test(t)) return GENRE_LINEUPS.urban.slice();
        if (/\b(rock|band|guitar|live band)\b/.test(t)) return GENRE_LINEUPS.rock.slice();
        if (/\b(jazz|swing|brass)\b/.test(t)) return GENRE_LINEUPS.jazz.slice();
        if (/\b(electronic|synth|minimal|edm|techno)\b/.test(t)) return GENRE_LINEUPS.electronic.slice();
        return GENRE_LINEUPS.urban.slice();
    }

    function renderCustomLineupList(indices) {
        var ul = document.getElementById('custom-lineup-list');
        if (!ul) return;
        ul.innerHTML = '';
        (indices || []).forEach(function (idx, i) {
            var m = getMusicianByIndex(idx);
            var li = document.createElement('li');
            li.setAttribute('data-index', String(idx));
            li.innerHTML = '<span class="ord">' + (i + 1) + '</span><span class="name-instr">' + m.display + '</span><button type="button" class="btn-remove" aria-label="Remove">×</button>';
                li.querySelector('.btn-remove').addEventListener('click', function () {
                    li.remove();
                    var list = document.getElementById('custom-lineup-list');
                    if (list) { for (var j = 0; j < list.children.length; j++) { var ord = list.children[j].querySelector('.ord'); if (ord) ord.textContent = j + 1; } }
                    buildNumTracksOptions(getCurrentLineup());
                });
                ul.appendChild(li);
            });
        buildNumTracksOptions(indices);
    }

    (function initGenreAndCustom() {
        var genreSel = document.getElementById('genre');
        var customPanel = document.getElementById('genre-custom-panel');
        var addMusicianSel = document.getElementById('add-musician-select');
        if (addMusicianSel) {
            MASTER_STUDIO_MUSICIANS.forEach(function (m, i) {
                var opt = document.createElement('option');
                opt.value = String(i);
                opt.textContent = m.name + ' · ' + m.instrument;
                addMusicianSel.appendChild(opt);
            });
        }
        if (genreSel) {
            genreSel.addEventListener('change', function () {
                var isCustom = genreSel.value === 'custom';
                if (customPanel) customPanel.classList.toggle('visible', isCustom);
                if (isCustom) {
                    var lineup = getCurrentLineup();
                    if (lineup.length === 0) lineup = GENRE_LINEUPS.reggaeton.slice();
                    renderCustomLineupList(lineup);
                } else {
                    buildNumTracksOptions(GENRE_LINEUPS[genreSel.value] || GENRE_LINEUPS.reggaeton);
                }
            });
        }
        var btnSuggest = document.getElementById('btn-suggest-lineup');
        var describeSound = document.getElementById('describe-sound');
        if (btnSuggest && describeSound) {
            btnSuggest.addEventListener('click', function () {
                var suggested = suggestLineupFromDescribe(describeSound.value);
                renderCustomLineupList(suggested);
            });
        }
        var btnAddMusician = document.getElementById('btn-add-musician');
        if (btnAddMusician && addMusicianSel) {
            btnAddMusician.addEventListener('click', function () {
                var val = addMusicianSel.value;
                if (val === '') return;
                var idx = parseInt(val, 10);
                var ul = document.getElementById('custom-lineup-list');
                if (!ul) return;
                if (ul.children.length >= 12) return;
                var m = getMusicianByIndex(idx);
                var li = document.createElement('li');
                li.setAttribute('data-index', String(idx));
                li.innerHTML = '<span class="ord">' + (ul.children.length + 1) + '</span><span class="name-instr">' + m.display + '</span><button type="button" class="btn-remove" aria-label="Remove">×</button>';
                li.querySelector('.btn-remove').addEventListener('click', function () {
                    li.remove();
                    buildNumTracksOptions(getCurrentLineup());
                });
                ul.appendChild(li);
                buildNumTracksOptions(getCurrentLineup());
            });
        }
    })();

    document.getElementById('motor-form').addEventListener('submit', function (e) {
        e.preventDefault();
        var btn = document.getElementById('btn-generate');
        var songsText = document.getElementById('songs-text').value.trim();
        var seed = document.getElementById('seed').value.trim() || 'C4';
        var edge = document.getElementById('edge').value.trim() || 'studio';
        var team = (document.getElementById('team').value || 'studio').toLowerCase();
        if (team !== 'concert') team = 'studio';
        var executive = document.getElementById('executive').value.trim() || 'smooth finish';
        var genre = (document.getElementById('genre') && document.getElementById('genre').value) || 'reggaeton';
        var lineup = getCurrentLineup();
        var numTracks = Math.min(12, Math.max(1, parseInt(document.getElementById('num-tracks').value, 10) || 6));
        numTracks = Math.min(numTracks, lineup.length);
        if (numTracks < 1) numTracks = 1;

        btn.disabled = true;
        var out = document.getElementById('output-section');
        var filenameEl = document.getElementById('output-filename');
        var downloadListEl = document.getElementById('download-list');
        var durationSec = textToDurationSec(songsText, executive);
        var baseTitle = songsText.slice(0, 60) || 'Seed-Edge-Song';
        var baseTime = Date.now();
        var trackBuffers = [];

        out.classList.add('visible');
        downloadListEl.innerHTML = '';
        filenameEl.textContent = 'Trying Hero Jo Golden Backdoor Hit Factory (full studio quality)…';
        filenameEl.className = 'status-msg';

        var apiBase = (typeof window !== 'undefined' && window.location && window.location.origin) ? window.location.origin : '';
        var promptForApi = genre + ' club hit. Vibe: ' + executive + '. Lyrics: ' + (songsText.slice(0, 500) || 'upbeat club track');
        var payload = { prompt: promptForApi, duration: durationSec, lyrics: songsText };

        function tryApi(endpoint, label) {
            return fetch(apiBase + endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(function (res) {
                if (res.status === 501 || !res.ok) return Promise.reject(new Error('API not configured or error'));
                return res.json();
            }).then(function (data) {
                if (!data || !data.url) return Promise.reject(new Error('No audio URL'));
                return { data: data, label: label };
            });
        }

        function fetchBlobAndDone(result) {
            return fetch(result.data.url).then(function (audioRes) {
                if (!audioRes.ok) return Promise.reject(new Error('Could not fetch audio'));
                return audioRes.blob();
            }).then(function (blob) {
                var filename = slug(baseTitle) + '_' + baseTime + '.wav';
                lastOutputs = [{ blob: blob, meta: { title: baseTitle, seed: seed, edge: edge, team: team, executive: executive, filename: filename, numTracks: 1 } }];
                filenameEl.textContent = 'Entire song ready (' + result.label + '): ' + filename;
                filenameEl.className = 'status-msg success';
                var a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                a.className = 'btn-download';
                a.style.display = 'inline-flex';
                a.style.marginRight = '0.75rem';
                a.style.marginBottom = '0.5rem';
                a.textContent = '↓ Download entire song (WAV)';
                a.title = filename;
                downloadListEl.appendChild(a);
                btn.disabled = false;
            });
        }

        tryApi('/api/music/generate-studio', 'Hero Jo Golden Backdoor Hit Factory')
            .then(fetchBlobAndDone)
            .catch(function (err) {
                filenameEl.innerHTML = 'No fallbacks — let\'s make it work. <strong>Connect</strong> your studio: set HEARTMULA_API_URL or REPLICATE_API_TOKEN. <a href="office-hours.html" style="color:#0d9488;font-weight:700;">Office Hours →</a>';
                filenameEl.className = 'status-msg error';
                btn.disabled = false;
            });

        function runNext(index) {
            if (index >= numTracks) {
                mixAudioBuffers(trackBuffers).then(function (mixedBuffer) {
                    var mixedBlob = audioBufferToWav(mixedBuffer);
                    var filename = slug(baseTitle) + '_' + baseTime + '.wav';
                    lastOutputs = [{
                        blob: mixedBlob,
                        meta: { title: baseTitle, seed: seed, edge: edge, team: team, executive: executive, filename: filename, numTracks: numTracks }
                    }];
                    filenameEl.textContent = 'Entire song ready: ' + filename;
                    filenameEl.className = 'status-msg success';
                    var a = document.createElement('a');
                    a.href = URL.createObjectURL(mixedBlob);
                    a.download = filename;
                    a.className = 'btn-download';
                    a.style.display = 'inline-flex';
                    a.style.marginRight = '0.75rem';
                    a.style.marginBottom = '0.5rem';
                    a.textContent = '↓ Download entire song (WAV)';
                    a.title = filename;
                    downloadListEl.appendChild(a);
                    btn.disabled = false;
                }).catch(function (err) {
                    filenameEl.textContent = 'Error mixing: ' + (err.message || 'mix failed');
                    filenameEl.className = 'status-msg error';
                    btn.disabled = false;
                });
                return;
            }
            var musician = getMusicianForTrack(index, lineup);
            renderTrack({
                text: songsText,
                seed: seed,
                edge: edge,
                team: team,
                executive: executive,
                durationSec: durationSec,
                trackIndex: index,
                musician: musician
            }).then(function (buffer) {
                trackBuffers.push(buffer);
                runNext(index + 1);
            }).catch(function (err) {
                filenameEl.textContent = 'Error (layer ' + (index + 1) + '): ' + (err.message || 'generation failed');
                filenameEl.className = 'status-msg error';
                btn.disabled = false;
            });
        }
    });

    document.getElementById('btn-add-playlist').addEventListener('click', function () {
        if (!lastOutputs.length) return;
        var item = lastOutputs[0];
        playlist.push({
            title: item.meta.title,
            seed: item.meta.seed,
            edge: item.meta.edge,
            team: item.meta.team,
            filename: item.meta.filename,
            url: URL.createObjectURL(item.blob)
        });
        savePlaylist();
        renderPlaylist();
    });

    document.getElementById('btn-add-catalog').addEventListener('click', function () {
        if (!lastOutputs.length) return;
        var now = new Date().toISOString();
        lastOutputs.forEach(function (item, i) {
            var trackId = 'TEXT-TO-TRACK-' + slug(item.meta.title).toUpperCase().replace(/_/g, '-') + '-' + Date.now() + (lastOutputs.length > 1 ? '-' + (i + 1) : '');
            var layers = item.meta.numTracks != null ? item.meta.numTracks : 6;
            var disp = item.meta.musicianDisplay || ('Entire song · ' + layers + ' layers');
            catalog.push({
                trackId: trackId,
                title: item.meta.title,
                seed: item.meta.seed,
                edge: item.meta.edge,
                team: item.meta.team,
                executive: item.meta.executive,
                filename: item.meta.filename,
                musicianDisplay: disp,
                musicianName: item.meta.musicianName,
                musicianInstrument: item.meta.musicianInstrument,
                generatedAt: now,
                protocol: 'TEXT-TO-TRACK-MOTOR-SEED-EDGE-NSPFRNP'
            });
        });
        saveCatalog();
        renderCatalog();
    });

    document.getElementById('btn-copy-catalog').addEventListener('click', function () {
        if (!lastOutputs.length) return;
        var first = lastOutputs[0].meta;
        var trackId = 'TEXT-TO-TRACK-' + slug(first.title).toUpperCase().replace(/_/g, '-') + '-' + Date.now();
        var md = '# ' + first.title + '\n\n' +
            '**Track ID:** `' + trackId + '`  \n' +
            '**Entire song:** One WAV (full song). Layers in mix: ' + (first.numTracks || 1) + '.  \n' +
            '**Team:** ' + (first.team || 'studio') + ' (artist creator gives exec instruction to his studio or concert team).  \n' +
            '**Seed:** ' + first.seed + '  \n' +
            '**Edge:** ' + first.edge + '  \n' +
            '**Executive:** ' + (first.executive || '') + '  \n' +
            '**Filename:** ' + first.filename + '  \n' +
            '**Generated:** ' + new Date().toISOString() + '  \n' +
            '**Protocol:** TEXT-TO-TRACK-MOTOR-SEED-EDGE-NSPFRNP  \n' +
            '**Status:** Production WAV · Copyright-free · Seed:Edge motor.\n\n---\n';
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(md).then(function () {
                var el = document.getElementById('output-filename');
                var prev = el.textContent;
                el.textContent = 'Catalog entry (NSPFRNP markdown) copied to clipboard. Paste into catalogs/music/ if desired.';
                el.className = 'status-msg success';
                setTimeout(function () { el.textContent = prev; }, 3000);
            });
        }
    });

    buildNumTracksOptions(getCurrentLineup());
    renderDreamTeamsList();
    renderPlaylist();
    renderCatalog();

    function applySongPreset(songId) {
        var songsTextEl = document.getElementById('songs-text');
        var genreEl = document.getElementById('genre');
        var edgeEl = document.getElementById('edge');
        var executiveEl = document.getElementById('executive');
        var numTracksEl = document.getElementById('num-tracks');
        var customPanel = document.getElementById('genre-custom-panel');
        if (genreEl) genreEl.value = 'reggaeton';
        if (customPanel) customPanel.classList.remove('visible');
        if (edgeEl) edgeEl.value = 'studio';
        if (songId === 'te-quiero-mucho-baby') {
            if (executiveEl) executiveEl.value = 'smooth finish, studio quality, 92 BPM';
        } else if (songId === 'dorila-gao') {
            if (executiveEl) executiveEl.value = 'club anthem, four-on-the-floor, 126 BPM';
        }
        buildNumTracksOptions(getCurrentLineup());
        if (numTracksEl) numTracksEl.value = songId === 'dorila-gao' ? '8' : '6';
        var url = songId === 'te-quiero-mucho-baby' ? '../catalogs/music/te-quiero-mucho-baby.md' : '../catalogs/music/dorila-gao-club-anthem.md';
        fetch(url).then(function (r) { return r.ok ? r.text() : Promise.reject(new Error('404')); }).then(function (md) {
            if (songsTextEl) songsTextEl.value = md;
            var out = document.getElementById('output-section');
            if (out) out.classList.remove('visible');
            var readyMsg = document.getElementById('preset-ready-msg');
            if (readyMsg) { readyMsg.style.display = 'block'; readyMsg.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); }
        }).catch(function () {
            var fallback = songId === 'te-quiero-mucho-baby'
                ? 'Te Quiero Mucho Baby (En Las Próximas 48 Horas)\n\nChairman Frankie feat. Dorila — Reggaetón Spanglish.\n\nCHORUS: Te quiero mucho baby — I love you so much baby. En las próximas 48 horas — in the next 48 hours. Vamos a ver si no estamos celebrando. Yo estoy listo, estoy muy listo. Ya no me interesa nada más. Sólo el dinero, fundar y aliviar. Toda la miseria de mi tribu. Urgente urgente, yo incluido.\n\nVERSE: Erika told me in Argentina, same thing you know. You keep saying it\'s gonna happen, and it is about to happen in the coming hours. Pick up the chorus, deliver it to me as a jewel please.\n\nSigned, Chairman Frankie — Ultimate VIP Baller V — Gold Heart.'
                : 'Dorila Gao — The Big Ass That Make All Da Men Go Gaga\n\nChairman Frankie feat. Dorila — Club dance anthem.\n\nHOOK: Dorila Gao — the big ass that make all da men go gaga. Dorila Gao — spin it, lay it down, you know how I like it daddy. Gao gao gao — Dorila Gao.\n\nVERSE: She from the coast, Afro-Colombian witch — Dorila Gao. Big ass make all da men go gaga. SQUEEZE! in the building, WINK! in the system. Gold heart baller V, locked and loaded, listen.\n\nClub anthem — signed Chairman Frankie — baller V.';
            if (songsTextEl) songsTextEl.value = fallback;
            var readyMsg = document.getElementById('preset-ready-msg');
            if (readyMsg) { readyMsg.style.display = 'block'; readyMsg.textContent = 'Lyrics loaded (fallback). Hit Generate entire song below.'; }
        });
    }

    (function checkSongParam() {
        var params = new URLSearchParams(typeof window !== 'undefined' && window.location && window.location.search ? window.location.search : '');
        var song = params.get('song');
        if (song === 'te-quiero-mucho-baby' || song === 'dorila-gao') {
            applySongPreset(song);
        }
    })();
})();
    </script>
    <link rel="stylesheet" href="nspfrnp-ticker.css">
    <link rel="stylesheet" href="gold-hearted-grown-ups-zone.css">
    <div class="nspfrnp-console-ticker" aria-live="polite"><span class="ticker-inner" id="nspfrnpTickerText"></span></div>
    <script src="gold-hearted-grown-ups-zone.js"></script>
    <script src="nspfrnp-ticker.js"></script>
</body>
</html>
